name: Build No-Auto Template

on:
  schedule:
    - cron: '0 3 * * *'   # 每天 03:00 UTC 自动执行（可改）
  workflow_dispatch:       # 允许手动触发

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Fetch upstream template
        run: |
          mkdir -p cfg
          curl -fsSL \
            'https://raw.githubusercontent.com/Aethersailor/Custom_OpenClash_Rules/main/cfg/Custom_Clash.ini' \
            -o cfg/Custom_Clash_upstream.ini

      # ① 删除“♻️ 自动选择”分组本体
      - name: Remove AutoSelect group line
        run: |
          perl -0777 -pe 's/^custom_proxy_group=♻️ 自动选择`url-test`.*\n?//mg' -i cfg/Custom_Clash_upstream.ini

      # ② 删除其它分组里对“自动选择”的引用（连同前面的反引号）
      - name: Remove AutoSelect references
        run: |
          perl -0777 -pe 's/`\\[\\]♻️ 自动选择//g' -i cfg/Custom_Clash_upstream.ini

      # ③ 把“[] 手动选择”放到所有 select 分组的第一个，然后去重
       - name: Put Manual first in all select groups
         run: |
      # 在每条 select 分组后插入一次 [] 手动选择`
          perl -0777 -pe 's/(^custom_proxy_group=.*?`select`)/\1[] 手动选择`/mg' -i cfg/Custom_Clash_upstream.ini
      # 同一行如果本来就有“[] 手动选择”，把重复的删掉（保留第一个）
          perl -0777 -pe 's/^(custom_proxy_group=.*?`select`\[\] 手动选择)(.*)$/ $1 . ($2=~s/`\[\] 手动选择//gr) /meg' -i cfg/Custom_Clash_upstream.ini

      # ④ 输出最终文件名
      - name: Write final file
        run: |
          cp cfg/Custom_Clash_upstream.ini cfg/Custom_Clash_no_auto.ini

      - name: Commit & push if changed
        run: |
          if ! git diff --quiet; then
            git add cfg/Custom_Clash_no_auto.ini
            git commit -m "chore: sync & strip AutoSelect + put Manual first"
            git push
          else
            echo "No changes."
          fi
