name: Build No-Auto Template

on:
  workflow_dispatch:       # 手动运行
  schedule:
    - cron: '0 3 * * *'    # 每天 11:00（北京）自动同步

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Fetch upstream template
        run: |
          mkdir -p cfg
          curl -fsSL \
            'https://raw.githubusercontent.com/Aethersailor/Custom_OpenClash_Rules/main/cfg/Custom_Clash.ini' \
            -o cfg/Custom_Clash_upstream.ini

      - name: Patch (remove AutoSelect & put Manual first)
        run: |
          python3 - << 'PY'
          import re, io, sys, pathlib
          p = pathlib.Path("cfg/Custom_Clash_upstream.ini")
          text = p.read_text(encoding="utf-8", errors="ignore").splitlines(True)

          out = []
          for line in text:
              # 1) 删除“♻️ 自动选择”分组本体这一整行
              if line.startswith("custom_proxy_group=♻️ 自动选择`url-test`"):
                  continue

              # 2) 删除所有对 []♻️ 自动选择 的引用（连同前面的反引号）
              line = line.replace("`[]♻️ 自动选择", "")

              # 3) 对所有 select 分组：把“[] 手动选择”放到第一位，并避免重复
              if line.startswith("custom_proxy_group=") and "`select`" in line:
                  # 去掉本行所有“[] 手动选择”（不管前面是否带反引号/空格）
                  line = re.sub(r"`?\[\]\s*手动选择", "", line)
                  # 只在第一次出现的 `select` 后面插入一次
                  line = line.replace("`select`", "`select`[] 手动选择`", 1)

              out.append(line)

          out_text = "".join(out)
          pathlib.Path("cfg/Custom_Clash_no_auto.ini").write_text(out_text, encoding="utf-8")
          print("Patched and wrote cfg/Custom_Clash_no_auto.ini")
          PY

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          if ! git diff --quiet; then
            git add cfg/Custom_Clash_no_auto.ini
            git commit -m "auto: strip AutoSelect & put Manual first"
            git push
          else
            echo "No changes."
          fi
